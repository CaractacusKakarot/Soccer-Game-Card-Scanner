<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AYSO Game Card Scanner • Coach Desk</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{extend:{
        colors:{brand:{50:'#e6f6f5',100:'#cef0ee',200:'#9ddfdb',300:'#6bcfcc',400:'#39c0ba',500:'#12b3ac',600:'#0f766e',700:'#0d5e58',800:'#0b4742',900:'#08312e'}},
        boxShadow:{soft:'0 10px 28px rgba(0,0,0,.12)'},
        fontFamily:{sans:['Inter','ui-sans-serif','system-ui','sans-serif']}
      }}
    }
  </script>
  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400..800&display=swap" rel="stylesheet" />
  <!-- Tesseract OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <!-- FileSaver for CSV downloads -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    html,body{height:100%}
    .chip{@apply inline-flex items-center px-2 py-0.5 rounded-full bg-brand-50 text-brand-700 text-xs}
    .btn{ @apply inline-flex items-center justify-center rounded-lg px-4 py-2 font-medium shadow-soft transition;
          background: linear-gradient(180deg,#12b3ac 0%,#0f766e 100%); color:white }
    .btn:hover{filter:brightness(1.05)}
    .btn-ghost{@apply rounded-lg px-4 py-2 border border-slate-300 text-slate-800 hover:bg-slate-50}
    .card{@apply rounded-2xl border border-slate-200 bg-white p-5 shadow-soft}
    .tab{ @apply px-4 py-2 rounded-full text-sm font-medium cursor-pointer }
    .tab-active{@apply bg-slate-900 text-white}
    .tab-inactive{@apply bg-slate-100 text-slate-700 hover:bg-slate-200}
    .kpi{ @apply text-center rounded-xl bg-slate-50 p-4 border border-slate-200 }
    .table{ @apply w-full text-sm border border-slate-200 rounded-xl overflow-hidden }
    .table th{ @apply bg-slate-100 text-left px-3 py-2 }
    .table td{ @apply border-t border-slate-200 px-3 py-2 }
  </style>
</head>
<body class="bg-white text-slate-900 font-sans">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="h-8 w-8 rounded-full bg-brand-600 inline-block"></span>
        <span class="font-semibold">Coach Desk — Game Card Scanner</span>
      </div>
      <nav class="hidden md:flex gap-2">
        <button class="tab tab-active" data-tab="scan">Scan</button>
        <button class="tab tab-inactive" data-tab="matches">Matches</button>
        <button class="tab tab-inactive" data-tab="standings">Standings</button>
        <button class="tab tab-inactive" data-tab="refs">Refs</button>
        <button class="tab tab-inactive" data-tab="export">Import/Export</button>
        <button class="tab tab-inactive" data-tab="settings">Settings</button>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-4 py-8 space-y-8">
    <!-- Scan -->
    <section id="tab-scan" class="grid lg:grid-cols-2 gap-6">
      <div class="card">
        <h2 class="text-lg font-semibold">1) Upload or Capture Game Card (Front & Back)</h2>
        <p class="text-sm text-slate-600 mt-1">Use your phone camera (best) or drag images here. Supported: JPG, PNG.</p>
        <div class="mt-4 flex flex-col gap-3">
          <input id="fileInput" type="file" accept="image/*" multiple capture="environment" class="block w-full border border-slate-300 rounded-lg p-2"/>
          <div id="drop" class="rounded-xl border-2 border-dashed border-slate-300 p-6 text-center text-slate-500">
            Drop images here
          </div>
          <div id="preview" class="grid grid-cols-2 gap-3"></div>
          <div class="flex items-center gap-3">
            <button id="btnOCR" class="btn">Run OCR</button>
            <span id="ocrStatus" class="text-sm text-slate-600"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="text-lg font-semibold">2) Review & Confirm Parsed Fields</h2>
        <p class="text-sm text-slate-600 mt-1">Edit anything the OCR guessed incorrectly. Then “Save Match”.</p>

        <form id="matchForm" class="grid grid-cols-2 gap-3 mt-4">
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Game ID</span>
            <input name="gameId" class="w-full border rounded-lg p-2" placeholder="e.g., 12-3-104" required />
          </label>
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Date</span>
            <input name="date" type="date" class="w-full border rounded-lg p-2" required />
          </label>
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Division</span>
            <input name="division" class="w-full border rounded-lg p-2" placeholder="12U Boys" />
          </label>
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Field</span>
            <input name="field" class="w-full border rounded-lg p-2" placeholder="Field 3" />
          </label>
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Home Team</span>
            <input name="homeTeam" class="w-full border rounded-lg p-2" required />
          </label>
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Away Team</span>
            <input name="awayTeam" class="w-full border rounded-lg p-2" required />
          </label>

          <div class="col-span-2 grid grid-cols-6 gap-2">
            <label class="col-span-3">
              <span class="text-xs text-slate-600">Home Score</span>
              <input name="homeScore" type="number" min="0" class="w-full border rounded-lg p-2" value="0"/>
            </label>
            <label class="col-span-3">
              <span class="text-xs text-slate-600">Away Score</span>
              <input name="awayScore" type="number" min="0" class="w-full border rounded-lg p-2" value="0"/>
            </label>
          </div>

          <div class="col-span-2 grid grid-cols-3 gap-2">
            <label>
              <span class="text-xs text-slate-600">CR</span>
              <input name="cr" class="w-full border rounded-lg p-2" placeholder="Center Ref"/>
            </label>
            <label>
              <span class="text-xs text-slate-600">AR1</span>
              <input name="ar1" class="w-full border rounded-lg p-2" placeholder="Assistant 1"/>
            </label>
            <label>
              <span class="text-xs text-slate-600">AR2</span>
              <input name="ar2" class="w-full border rounded-lg p-2" placeholder="Assistant 2"/>
            </label>
          </div>

          <div class="col-span-2 grid grid-cols-2 gap-2">
            <label>
              <span class="text-xs text-slate-600">Home Goals (player:Q,min; …)</span>
              <input name="homeGoals" class="w-full border rounded-lg p-2" placeholder="10:Q2,8; 7:Q3,4" />
            </label>
            <label>
              <span class="text-xs text-slate-600">Away Goals (player:Q,min; …)</span>
              <input name="awayGoals" class="w-full border rounded-lg p-2" placeholder="5:Q1,12" />
            </label>
          </div>

          <div class="col-span-2 grid grid-cols-2 gap-2">
            <label>
              <span class="text-xs text-slate-600">Home Keepers % (player:percent; …)</span>
              <input name="homeKeepers" class="w-full border rounded-lg p-2" placeholder="1:50; 12:50" />
            </label>
            <label>
              <span class="text-xs text-slate-600">Away Keepers % (player:percent; …)</span>
              <input name="awayKeepers" class="w-full border rounded-lg p-2" placeholder="99:100" />
            </label>
          </div>

          <div class="col-span-2">
            <span class="text-xs text-slate-600">Home Lineup by Quarter (Q1|Q2|Q3|Q4: comma numbers)</span>
            <input name="homeLineup" class="w-full border rounded-lg p-2" placeholder="Q1:2,4,7,9,10; Q2:…"/>
          </div>
          <div class="col-span-2">
            <span class="text-xs text-slate-600">Away Lineup by Quarter</span>
            <input name="awayLineup" class="w-full border rounded-lg p-2" placeholder="Q1:3,5,8,11,15; Q2:…"/>
          </div>
          <div class="col-span-2">
            <span class="text-xs text-slate-600">Notes</span>
            <textarea name="notes" class="w-full border rounded-lg p-2" rows="2" placeholder="Cards, injuries, highlights"></textarea>
          </div>
        </form>

        <div class="mt-4 flex gap-3">
          <button id="btnSave" class="btn">Save Match</button>
          <button id="btnClear" class="btn-ghost">Clear</button>
        </div>
      </div>
    </section>

    <!-- Matches -->
    <section id="tab-matches" class="hidden">
      <div class="card">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Saved Matches</h2>
          <div class="flex gap-2">
            <input id="searchMatch" placeholder="Search team or gameId…" class="border rounded-lg p-2"/>
            <button id="btnRecalc" class="btn-ghost">Recalculate Standings</button>
          </div>
        </div>
        <div class="mt-4 overflow-x-auto">
          <table class="table" id="matchesTable">
            <thead>
              <tr>
                <th>Date</th><th>Game</th><th>Division</th><th>Field</th>
                <th>Home</th><th></th><th>Away</th>
                <th>CR</th><th>AR1</th><th>AR2</th><th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Standings -->
    <section id="tab-standings" class="hidden">
      <div class="grid md:grid-cols-3 gap-6">
        <div class="kpi"><div class="text-2xl font-semibold" id="kpiGames">0</div><div class="text-slate-600 text-sm">Games Recorded</div></div>
        <div class="kpi"><div class="text-2xl font-semibold" id="kpiGoals">0</div><div class="text-slate-600 text-sm">Total Goals</div></div>
        <div class="kpi"><div class="text-2xl font-semibold" id="kpiRefs">0</div><div class="text-slate-600 text-sm">Ref Assignments</div></div>
      </div>
      <div class="card mt-6">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Standings</h2>
          <div class="text-sm text-slate-600">Points: W=3, D=1, L=0</div>
        </div>
        <div class="mt-4 overflow-x-auto">
          <table class="table" id="standingsTable">
            <thead>
              <tr>
                <th>Division</th><th>Team</th><th>GP</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Refs -->
    <section id="tab-refs" class="hidden">
      <div class="card">
        <h2 class="text-lg font-semibold">Referee Assignments</h2>
        <div class="mt-4 overflow-x-auto">
          <table class="table" id="refsTable">
            <thead>
              <tr><th>Name</th><th>CR</th><th>AR</th><th>Total</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Import/Export -->
    <section id="tab-export" class="hidden grid lg:grid-cols-2 gap-6">
      <div class="card">
        <h2 class="text-lg font-semibold">Export CSV</h2>
        <p class="text-sm text-slate-600">Use these to paste into Google Sheets.</p>
        <div class="mt-4 flex flex-wrap gap-2">
          <button class="btn" id="exportMatches">Matches CSV</button>
          <button class="btn" id="exportGoals">Goals CSV</button>
          <button class="btn" id="exportRefs">Refs CSV</button>
          <button class="btn-ghost" id="exportJSON">Backup (JSON)</button>
        </div>
      </div>
      <div class="card">
        <h2 class="text-lg font-semibold">Import Schedule (CSV)</h2>
        <p class="text-sm text-slate-600">Optional: preload your schedule. Headers supported: gameId,date,division,field,homeTeam,awayTeam</p>
        <input id="importCSV" type="file" accept=".csv" class="mt-4 border rounded-lg p-2"/>
      </div>
      <div class="card lg:col-span-2">
        <h3 class="text-md font-semibold mb-2">How auto-updates work</h3>
        <ul class="list-disc ml-6 text-sm text-slate-700 space-y-1">
          <li>Every saved match instantly recomputes standings (per division).</li>
          <li>Ref table tallies CR/AR assignments.</li>
          <li>Keeper percentages and lineups are stored per match for coach review.</li>
        </ul>
      </div>
    </section>

    <!-- Settings -->
    <section id="tab-settings" class="hidden">
      <div class="card">
        <h2 class="text-lg font-semibold">Settings</h2>
        <div class="mt-4 grid sm:grid-cols-2 gap-4">
          <label class="flex items-center gap-3">
            <input id="optAutoId" type="checkbox" class="h-4 w-4 border rounded"/>
            <span class="text-sm">Auto-generate Game IDs if missing</span>
          </label>
          <label class="flex items-center gap-3">
            <input id="optLocalOnly" type="checkbox" class="h-4 w-4 border rounded" checked/>
            <span class="text-sm">Store data locally (browser only)</span>
          </label>
        </div>
        <div class="mt-6 flex gap-2">
          <button id="wipe" class="btn-ghost">Wipe All Local Data</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="border-t border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-8 text-sm text-slate-600 flex items-center justify-between">
      <span>© <span id="year"></span> Coach Desk</span>
      <span class="chip">Offline-friendly</span>
    </div>
  </footer>

  <script>
  // ---------- Utilities ----------
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  const toCSV = (rows) => rows.map(r => r.map(v=>{
    const s = String(v ?? '');
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(',')).join('\n');
  const uid = () => Math.random().toString(36).slice(2,8);

  const LS_KEY = 'coachdesk:v1';
  const state = JSON.parse(localStorage.getItem(LS_KEY) || '{"matches":[],"schedule":[]}');

  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  // ---------- Tabs ----------
  const tabs = $$('.tab');
  const sections = {
    scan: $('#tab-scan'), matches: $('#tab-matches'),
    standings: $('#tab-standings'), refs: $('#tab-refs'),
    export: $('#tab-export'), settings: $('#tab-settings')
  };
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.forEach(b=>b.classList.replace('tab-active','tab-inactive'));
      btn.classList.replace('tab-inactive','tab-active');
      const k = btn.dataset.tab;
      Object.entries(sections).forEach(([key,el])=>{
        el.classList.toggle('hidden', key!==k);
      });
      if(k==='matches') renderMatches();
      if(k==='standings') recompute();
      if(k==='refs') renderRefs();
    });
  });

  // ---------- Drag & Drop ----------
  const drop = $('#drop'), fileInput = $('#fileInput'), preview = $('#preview');
  function handleFiles(files){
    preview.innerHTML='';
    [...files].forEach(f=>{
      const url = URL.createObjectURL(f);
      const img = document.createElement('img');
      img.src=url; img.alt=f.name;
      img.className='w-full h-40 object-cover rounded-xl border';
      preview.appendChild(img);
    });
  }
  fileInput.addEventListener('change', e=> handleFiles(e.target.files));
  ;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('bg-slate-50'); }));
  ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('bg-slate-50'); }));
  drop.addEventListener('drop', e=> { handleFiles(e.dataTransfer.files); });

  // ---------- OCR ----------
  const ocrStatus = $('#ocrStatus');
  $('#btnOCR').addEventListener('click', async ()=>{
    const files = fileInput.files;
    if(!files?.length){ alert('Add the front/back images first.'); return; }
    ocrStatus.textContent='Scanning…';
    let text = '';
    for (const f of files){
      const { data } = await Tesseract.recognize(f, 'eng', { logger:m=>{ if(m.status==='recognizing text'){ ocrStatus.textContent=`${m.status} ${Math.round(m.progress*100)}%`; } }});
      text += '\n' + data.text;
    }
    ocrStatus.textContent='Parsing…';
    fillFormFromText(text);
    ocrStatus.textContent='Done. Review & Save.';
  });

  // Very light heuristics — adjust to your card layout
  function fillFormFromText(s){
    const F = $('#matchForm');
    const get = (re, group=1) => (s.match(re)||[])[group] || '';
    F.gameId.value = get(/Game\s*#?\s*[:\-]?\s*([A-Za-z0-9\-]+)/i) || ( $('#optAutoId').checked ? `G-${uid()}`:'' );
    F.date.value = (()=>{
      const d = get(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2}|\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4})/);
      if(!d) return '';
      const parts = d.replace(/[^0-9\/\-]/g,'').split(/[\/\-]/).map(n=>+n);
      // naive normalization: prefer YYYY-MM-DD
      if(parts[0]>1900) return [parts[0], String(parts[1]).padStart(2,'0'), String(parts[2]).padStart(2,'0')].join('-');
      return ''; // let user edit if ambiguous
    })();
    F.division.value = get(/(8U|10U|12U|14U|16U|19U)\s*(Boys|Girls)?/i);
    F.field.value = get(/Field\s*[:\-]?\s*([A-Za-z0-9\-]+)/i);
    F.homeTeam.value = get(/Home\s*Team\s*[:\-]?\s*([A-Za-z0-9 \-']+)/i);
    F.awayTeam.value = get(/Away\s*Team\s*[:\-]?\s*([A]()*
