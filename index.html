<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AYSO Game Card Scanner • Coach Desk</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{extend:{
        colors:{brand:{
          50:'#e6f6f5',100:'#cef0ee',200:'#9ddfdb',300:'#6bcfcc',
          400:'#39c0ba',500:'#12b3ac',600:'#0f766e',
          700:'#0d5e58',800:'#0b4742',900:'#08312e'}},
        boxShadow:{soft:'0 12px 32px rgba(0,0,0,.10)'},
        fontFamily:{sans:['Inter','ui-sans-serif','system-ui','sans-serif']}
      }}
    }
  </script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400..800&display=swap" rel="stylesheet" />

  <!-- OCR + FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    html,body{height:100%}
    .btn{ background:linear-gradient(180deg,#12b3ac 0%,#0f766e 100%); color:#fff;
      border-radius:.75rem; padding:.6rem 1rem; font-weight:600; box-shadow:0 10px 28px rgba(0,0,0,.12) }
    .btn:hover{ filter:brightness(1.05) }
    .btn-ghost{ border:1px solid #d1d5db; padding:.55rem 1rem; border-radius:.75rem }
    .tab{ padding:.45rem 1rem; border-radius:9999px; cursor:pointer }
    .tab-active{ background:#0f172a; color:#fff }
    .tab-inactive{ background:#e7edf5; color:#111827 }
    .card{ border:1px solid #e2e8f0; border-radius:1rem; background:#fff; padding:1rem 1.25rem; box-shadow:0 10px 28px rgba(0,0,0,.06) }
    .table th{ background:#f1f5f9; font-weight:600; text-align:left; padding:.55rem .6rem }
    .table td{ border-top:1px solid #e2e8f0; padding:.5rem .6rem }
    .kpi{ border:1px solid #e2e8f0; border-radius:1rem; background:#fff; padding:1rem; text-align:center }
    .chip{ display:inline-flex; align-items:center; font-size:.75rem; padding:.25rem .6rem; border-radius:999px; background:#eef2f7 }
    .dz{ border:2px dashed #cbd5e1; border-radius:1rem; padding:1.25rem; text-align:center; color:#475569 }
    .dz.hover{ background:#f8fafc }
    .sr{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0 }

    /* Progress ring */
    .ring { width:54px;height:54px; display:inline-block; position:relative }
    .ring svg { transform:rotate(-90deg) }
    .ring circle { fill:none; stroke-width:10; }
    .ring .bg { stroke:#e5e7eb }
    .ring .fg { stroke:#0f766e; stroke-linecap:round; transition:stroke-dashoffset .15s linear }

    /* Dark mode (basic) */
    .dark body{ background:#0b1220; color:#e5e7eb }
    .dark .card{ background:#0f172a; border-color:#1f2937 }
    .dark .table th{ background:#111827 }
    .dark .table td{ border-color:#1f2937 }
    .dark .btn-ghost{ border-color:#334155; color:#e5e7eb }
    .dark .tab-inactive{ background:#0b1625; color:#e5e7eb }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="inline-block h-8 w-8 rounded-full bg-brand-600"></span>
        <span class="font-semibold">Coach Desk — Game Card Scanner</span>
      </div>
      <nav class="hidden md:flex gap-2">
        <button class="tab tab-active" data-tab="scan">Scan</button>
        <button class="tab tab-inactive" data-tab="matches">Matches</button>
        <button class="tab tab-inactive" data-tab="standings">Standings</button>
        <button class="tab tab-inactive" data-tab="refs">Refs</button>
        <button class="tab tab-inactive" data-tab="io">Import/Export</button>
        <button class="tab tab-inactive" data-tab="settings">Settings</button>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-4 py-8 space-y-8">
    <!-- SCAN -->
    <section id="tab-scan" class="space-y-6">
      <!-- flow -->
      <div class="flex flex-wrap items-center gap-3 text-sm">
        <span class="chip">1. Scan Card</span>
        <span class="chip">2. OCR</span>
        <span class="chip">3. Review & Save</span>
      </div>

      <!-- Scan button -->
      <div class="card flex items-center justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold">Scan AYSO Game Card</h2>
          <p class="text-sm text-slate-600">On mobile, we’ll prompt for <b>Front</b> then <b>Back</b>. You can also upload images from files.</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnScan" class="btn">Scan Card</button>
          <label class="btn-ghost cursor-pointer">
            <input id="filePicker" class="sr" type="file" accept="image/*" multiple>
            Or Upload Images
          </label>
        </div>
      </div>

      <!-- Front/Back panels -->
      <div class="grid lg:grid-cols-2 gap-6">
        <!-- Front -->
        <div class="card">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Front</h3>
            <label class="btn-ghost cursor-pointer">
              <input id="frontInput" class="sr" type="file" accept="image/*" capture="environment">
              Replace Front
            </label>
          </div>

          <div id="frontDrop" class="dz mt-3">Drop front image here</div>
          <div class="mt-3 flex items-center gap-4">
            <img id="frontPreview" class="hidden w-40 h-40 object-cover rounded-lg border" alt="Front preview"/>
            <div class="flex items-center gap-3">
              <div class="ring">
                <svg viewBox="0 0 120 120">
                  <circle class="bg" cx="60" cy="60" r="54"></circle>
                  <circle id="frontRing" class="fg" cx="60" cy="60" r="54"
                    stroke-dasharray="339.292" stroke-dashoffset="339.292"></circle>
                </svg>
              </div>
              <div>
                <div class="text-sm font-medium">OCR Status</div>
                <div id="frontStatus" class="text-xs text-slate-600">Waiting…</div>
              </div>
            </div>
          </div>
          <button id="frontToggleText" class="btn-ghost mt-3 hidden">Show detected text</button>
          <pre id="frontText" class="hidden mt-2 text-xs bg-slate-900 text-slate-100 p-2 rounded max-h-48 overflow-auto"></pre>
        </div>

        <!-- Back -->
        <div class="card">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Back</h3>
            <label class="btn-ghost cursor-pointer">
              <input id="backInput" class="sr" type="file" accept="image/*" capture="environment">
              Replace Back
            </label>
          </div>

          <div id="backDrop" class="dz mt-3">Drop back image here</div>
          <div class="mt-3 flex items-center gap-4">
            <img id="backPreview" class="hidden w-40 h-40 object-cover rounded-lg border" alt="Back preview"/>
            <div class="flex items-center gap-3">
              <div class="ring">
                <svg viewBox="0 0 120 120">
                  <circle class="bg" cx="60" cy="60" r="54"></circle>
                  <circle id="backRing" class="fg" cx="60" cy="60" r="54"
                    stroke-dasharray="339.292" stroke-dashoffset="339.292"></circle>
                </svg>
              </div>
              <div>
                <div class="text-sm font-medium">OCR Status</div>
                <div id="backStatus" class="text-xs text-slate-600">Waiting…</div>
              </div>
            </div>
          </div>
          <button id="backToggleText" class="btn-ghost mt-3 hidden">Show detected text</button>
          <pre id="backText" class="hidden mt-2 text-xs bg-slate-900 text-slate-100 p-2 rounded max-h-48 overflow-auto"></pre>
        </div>
      </div>

      <!-- Match Editor -->
      <div class="card">
        <h3 class="text-lg font-semibold">Match Review & Entry</h3>
        <p class="text-sm text-slate-600">The scanner will try to populate these. Confirm before saving.</p>

        <!-- General -->
        <div class="grid sm:grid-cols-3 gap-3 mt-3">
          <label><span class="text-xs text-slate-600">Game ID</span><input id="m-id" class="w-full border rounded-lg p-2" placeholder="e.g., 12-3-104"/></label>
          <label><span class="text-xs text-slate-600">Date</span><input id="m-date" type="date" class="w-full border rounded-lg p-2"/></label>
          <label><span class="text-xs text-slate-600">Division</span><input id="m-div" class="w-full border rounded-lg p-2" placeholder="12U Boys"/></label>
          <label><span class="text-xs text-slate-600">Field</span><input id="m-field" class="w-full border rounded-lg p-2" placeholder="Field 3"/></label>
          <label><span class="text-xs text-slate-600">Home Team</span><input id="m-home" class="w-full border rounded-lg p-2"/></label>
          <label><span class="text-xs text-slate-600">Away Team</span><input id="m-away" class="w-full border rounded-lg p-2"/></label>
        </div>

        <!-- Score + Refs -->
        <div class="grid sm:grid-cols-3 gap-3 mt-4">
          <label><span class="text-xs text-slate-600">Home Score</span><input id="m-hs" type="number" min="0" class="w-full border rounded-lg p-2" value="0"/></label>
          <label><span class="text-xs text-slate-600">Away Score</span><input id="m-as" type="number" min="0" class="w-full border rounded-lg p-2" value="0"/></label>
          <div class="rounded-lg bg-slate-50 p-2 text-sm">Points: W=3, D=1, L=0 (change in Settings)</div>

          <label><span class="text-xs text-slate-600">Center Ref (CR)</span><input id="m-cr" class="w-full border rounded-lg p-2"/></label>
          <label><span class="text-xs text-slate-600">Assistant Ref 1 (AR1)</span><input id="m-ar1" class="w-full border rounded-lg p-2"/></label>
          <label><span class="text-xs text-slate-600">Assistant Ref 2 (AR2)</span><input id="m-ar2" class="w-full border rounded-lg p-2"/></label>
        </div>

        <!-- Rosters -->
        <div class="grid lg:grid-cols-2 gap-6 mt-6">
          <div>
            <div class="flex items-center justify-between">
              <h4 class="font-semibold">Home Roster & Quarters</h4>
              <button class="btn-ghost text-sm" id="addHomePlayer">Add Player</button>
            </div>
            <p class="text-xs text-slate-600 mb-2">AYSO uses quarters. Check ✓ if the player <b>played</b> that quarter; leave empty if they <b>sat</b>. Toggle GK if they were keeper.</p>
            <table class="w-full table text-sm" id="homeRoster">
              <thead><tr><th>#</th><th>Absent</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>GK</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <div class="flex items-center justify-between">
              <h4 class="font-semibold">Away Roster & Quarters</h4>
              <button class="btn-ghost text-sm" id="addAwayPlayer">Add Player</button>
            </div>
            <p class="text-xs text-slate-600 mb-2">Same tracking for away side.</p>
            <table class="w-full table text-sm" id="awayRoster">
              <thead><tr><th>#</th><th>Absent</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>GK</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Goals -->
        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">Goals & Events</h4>
            <button class="btn-ghost text-sm" id="addGoal">Add Goal</button>
          </div>
          <table class="w-full table text-sm mt-2" id="goalsTable">
            <thead><tr><th>Team</th><th>Player #</th><th>Quarter</th><th>Minute</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Notes -->
        <div class="mt-4">
          <label class="block"><span class="text-xs text-slate-600">Notes (cards, injuries, highlights)</span>
            <textarea id="m-notes" rows="3" class="w-full border rounded-lg p-2"></textarea>
          </label>
        </div>

        <div class="mt-5 flex flex-wrap gap-3">
          <button id="saveMatch" class="btn">Save Match</button>
          <button id="clearMatch" class="btn-ghost">Start New</button>
        </div>
      </div>
    </section>
    <!-- MATCHES -->
    <section id="tab-matches" class="hidden space-y-4">
      <div class="flex flex-wrap items-center gap-2">
        <input id="matchSearch" placeholder="Search team or game ID…" class="border rounded-lg p-2 w-64"/>
        <select id="filterDiv" class="border rounded-lg p-2"><option value="">All divisions</option></select>
      </div>
      <div class="card">
        <h3 class="text-lg font-semibold">Saved Matches</h3>
        <div class="mt-3 overflow-x-auto">
          <table class="w-full table text-sm" id="matchesTable">
            <thead>
              <tr><th>Date</th><th>Game</th><th>Division</th><th>Field</th><th>Home</th><th></th><th>Away</th><th>CR</th><th>AR1</th><th>AR2</th><th>Score</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- STANDINGS -->
    <section id="tab-standings" class="hidden space-y-4">
      <div class="grid sm:grid-cols-4 gap-4">
        <div class="kpi"><div class="text-2xl font-semibold" id="kpiGames">0</div><div class="text-slate-600 text-sm">Games Recorded</div></div>
        <div class="kpi"><div class="text-2xl font-semibold" id="kpiGoals">0</div><div class="text-slate-600 text-sm">Total Goals</div></div>
        <div class="kpi"><div class="text-2xl font-semibold" id="kpiRefs">0</div><div class="text-slate-600 text-sm">Ref Assignments</div></div>
        <div class="kpi"><div class="text-2xl font-semibold" id="kpiDivs">0</div><div class="text-slate-600 text-sm">Divisions</div></div>
      </div>
      <div class="card">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Standings</h3>
          <div class="text-sm text-slate-600">Points: <span id="ptsRule">W=3, D=1, L=0</span></div>
        </div>
        <div class="mt-3 overflow-x-auto">
          <table class="w-full table text-sm" id="standingsTable">
            <thead>
              <tr><th>Division</th><th>Team</th><th>GP</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REFS -->
    <section id="tab-refs" class="hidden">
      <div class="card">
        <h3 class="text-lg font-semibold">Referee Assignments</h3>
        <div class="mt-3 overflow-x-auto">
          <table class="w-full table text-sm" id="refsTable">
            <thead><tr><th>Name</th><th>CR</th><th>AR1</th><th>AR2</th><th>Total</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- IMPORT / EXPORT -->
    <section id="tab-io" class="hidden grid lg:grid-cols-2 gap-6">
      <div class="card">
        <h3 class="text-lg font-semibold">Export</h3>
        <div class="mt-3 flex flex-wrap gap-2">
          <button class="btn" id="exMatches">Matches CSV</button>
          <button class="btn" id="exStandings">Standings CSV</button>
          <button class="btn" id="exRefs">Refs CSV</button>
          <button class="btn-ghost" id="exJSON">Backup JSON</button>
        </div>
      </div>
      <div class="card">
        <h3 class="text-lg font-semibold">Import Schedule (CSV)</h3>
        <p class="text-sm text-slate-600">Headers: gameId,date,division,field,homeTeam,awayTeam</p>
        <input id="impCSV" type="file" accept=".csv" class="mt-3 border rounded-lg p-2"/>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="hidden space-y-4">
      <div class="card">
        <h3 class="text-lg font-semibold">Preferences</h3>
        <div class="grid md:grid-cols-3 gap-4 mt-3">
          <label class="flex items-center gap-3"><input id="optDark" type="checkbox" class="h-4 w-4 border rounded"><span>Dark Mode</span></label>
          <label class="flex items-center gap-3"><input id="optAutoId" type="checkbox" class="h-4 w-4 border rounded" checked><span>Auto-generate Game IDs</span></label>
          <label class="flex items-center gap-3"><input id="optLocal" type="checkbox" class="h-4 w-4 border rounded" checked><span>Store Locally (browser)</span></label>
          <label><span class="text-xs text-slate-600">Points (W/D/L)</span>
            <div class="flex gap-2"><input id="ptsW" type="number" class="border rounded-lg p-2 w-16" value="3"><input id="ptsD" type="number" class="border rounded-lg p-2 w-16" value="1"><input id="ptsL" type="number" class="border rounded-lg p-2 w-16" value="0"></div>
          </label>
          <label><span class="text-xs text-slate-600">Quarter length (minutes)</span>
            <input id="qLen" type="number" class="border rounded-lg p-2 w-28" value="15">
          </label>
        </div>
        <div class="mt-4 flex gap-2">
          <button id="wipeAll" class="btn-ghost">Wipe All Local Data</button>
          <button id="savePrefs" class="btn">Save Settings</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="border-t border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-8 text-sm text-slate-600 flex items-center justify-between">
      <span>© <span id="year"></span> Coach Desk</span>
      <span class="chip">Offline-friendly</span>
    </div>
  </footer>
  <!-- JS -->
  <script>
/* ========= Utilities ========= */
const $  = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
const byId = id => document.getElementById(id);
const LS_KEY='coachdesk:v3';
const PREFS_KEY='coachdesk:prefs';
const uid = () => Math.random().toString(36).slice(2,8);
const toCSV = rows => rows.map(r=>r.map(v=>{
  const s=String(v??''); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;
}).join(',')).join('\n');

let state = JSON.parse(localStorage.getItem(LS_KEY) || '{"matches":[]}');
let prefs = JSON.parse(localStorage.getItem(PREFS_KEY) || '{"pts":[3,1,0],"qLen":15,"dark":false,"autoId":true}');

function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function savePrefs(){ localStorage.setItem(PREFS_KEY, JSON.stringify(prefs)); }

/* ========= Tabs ========= */
const sections={scan:'#tab-scan',matches:'#tab-matches',standings:'#tab-standings',refs:'#tab-refs',io:'#tab-io',settings:'#tab-settings'};
$$('nav .tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    $$('nav .tab').forEach(b=>b.classList.replace('tab-active','tab-inactive'));
    btn.classList.replace('tab-inactive','tab-active');
    Object.values(sections).forEach(sel=>$(sel).classList.add('hidden'));
    $(sections[btn.dataset.tab]).classList.remove('hidden');
    if(btn.dataset.tab==='matches') renderMatches();
    if(btn.dataset.tab==='standings') recompute();
    if(btn.dataset.tab==='refs') renderRefs();
  });
});

/* ========= Progress Ring helpers ========= */
const CIRC=339.292; // circumference for r=54
function setRing(el, pct){ // pct: 0..1
  el.style.strokeDasharray = CIRC;
  el.style.strokeDashoffset = String(CIRC*(1-Math.max(0,Math.min(1,pct))));
}

/* ========= Scan/Upload flow ========= */
const frontInput=byId('frontInput'), backInput=byId('backInput'), filePicker=byId('filePicker');
const frontDrop=byId('frontDrop'), backDrop=byId('backDrop');
const frontPrev=byId('frontPreview'), backPrev=byId('backPreview');
const frontRing=byId('frontRing'), backRing=byId('backRing');
const frontStatus=byId('frontStatus'), backStatus=byId('backStatus');
const frontText=byId('frontText'), backText=byId('backText');
const frontToggleText=byId('frontToggleText'), backToggleText=byId('backToggleText');
let ocr = {front:'', back:''};

function attachDZ(drop, input, onFile){
  drop.addEventListener('dragover', e=>{e.preventDefault();drop.classList.add('hover');});
  drop.addEventListener('dragleave', ()=>drop.classList.remove('hover'));
  drop.addEventListener('drop', e=>{
    e.preventDefault(); drop.classList.remove('hover');
    if(e.dataTransfer.files?.[0]) onFile(e.dataTransfer.files[0]);
  });
  input.addEventListener('change', e=>{ if(e.target.files?.[0]) onFile(e.target.files[0]); });
}
attachDZ(frontDrop, frontInput, f=>handleImage('front',f));
attachDZ(backDrop,  backInput,  f=>handleImage('back', f));

byId('btnScan').addEventListener('click', async ()=>{
  // Mobile-friendly: prompt front then back
  await frontInput.click();
  // wait small tick for user capture; back prompt after a delay when front is chosen
  const watchFront = setInterval(()=>{
    if(frontInput.files?.[0]){ clearInterval(watchFront); setTimeout(()=>backInput.click(), 450); }
  }, 250);
});
filePicker.addEventListener('change', e=>{
  const files=[...e.target.files];
  if(files[0]) handleImage('front', files[0]);
  if(files[1]) handleImage('back', files[1]);
});

frontToggleText.onclick = ()=> frontText.classList.toggle('hidden');
backToggleText.onclick  = ()=> backText.classList.toggle('hidden');

async function handleImage(side, file){
  const isFront=side==='front';
  const img = isFront?frontPrev:backPrev;
  const ring= isFront?frontRing:backRing;
  const stat= isFront?frontStatus:backStatus;
  const pre = isFront?frontText:backText;

  const url = URL.createObjectURL(file);
  img.src=url; img.classList.remove('hidden');
  setRing(ring, 0); stat.textContent='Loading…';
  pre.textContent=''; (isFront?frontToggleText:backToggleText).classList.add('hidden');

  // run OCR
  const { data } = await Tesseract.recognize(file,'eng',{ logger:m=>{
    if(m.status==='recognizing text'){ setRing(ring, m.progress); stat.textContent=`${Math.round(m.progress*100)}%`; }
    else if(m.status){ stat.textContent = m.status.replace(/_/g,' '); }
  }});
  (isFront? (ocr.front=data.text):(ocr.back=data.text));
  pre.textContent = data.text || '(no text detected)';
  (isFront?frontToggleText:backToggleText).classList.remove('hidden');

  // try parse combined text
  parseToForm((ocr.front||'')+'\n'+(ocr.back||''));
}

/* ========= Parsing heuristics (tune for your region) ========= */
function parseToForm(text){
  const get=(re,g=1)=>{
    const m = text.match(re); return m? (m[g]||'').toString().trim() : '';
  };
  const set=(id,val)=>{ const el=byId(id); if(val && !el.value) el.value=val; };

  // game id
  set('m-id', get(/Game\s*(?:ID|#)?\s*[:\-]?\s*([A-Za-z0-9\-]+)/i) || (prefs.autoId?`G-${uid()}`:''));

  // date (yyyy-mm-dd or mm/dd/yy)
  const d = get(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2}|\b\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}\b)/);
  if(d && !byId('m-date').value){
    const parts=d.replace(/[^0-9\/\-]/g,'').split(/[\/\-]/).map(n=>+n);
    if(parts[0]>1900){
      byId('m-date').value=[parts[0], String(parts[1]).padStart(2,'0'), String(parts[2]).padStart(2,'0')].join('-');
    } // else ambiguous, leave for manual
  }

  // division (e.g., 12U Boys)
  set('m-div', get(/\b(6U|8U|10U|12U|14U|16U|19U)\s*(Boys|Girls|Coed)?\b/i));

  // field
  set('m-field', get(/Field\s*[:\-]?\s*([A-Za-z0-9\-]+)\b/i));

  // teams
  // Try explicit "Home Team:" etc, then looser "Home:" / "Away:"
  set('m-home', get(/Home\s*(?:Team)?\s*[:\-]\s*([A-Za-z0-9 '\-]{2,})/i) || get(/\bHome\b[^\n:]*[:\-]\s*([A-Za-z0-9 '\-]{2,})/i));
  set('m-away', get(/Away\s*(?:Team)?\s*[:\-]\s*([A-Za-z0-9 '\-]{2,})/i) || get(/\bAway\b[^\n:]*[:\-]\s*([A-Za-z0-9 '\-]{2,})/i));

  // scores
  const hs = get(/Home\s*(?:Score|Goals?)\s*[:\-]?\s*(\d{1,2})\b/i);
  const as = get(/Away\s*(?:Score|Goals?)\s*[:\-]?\s*(\d{1,2})\b/i);
  set('m-hs', hs); set('m-as', as);

  // refs
  set('m-cr',  get(/(?:CR|Center|Referee|Ref)\s*[:\-]?\s*([A-Za-z .'\-]{3,})/i));
  set('m-ar1', get(/\bAR1?\b\s*[:\-]?\s*([A-Za-z .'\-]{3,})/i));
  set('m-ar2', get(/\bAR2?\b\s*[:\-]?\s*([A-Za-z .'\-]{3,})/i));

  // goals lines (very heuristic: "G: #10 Q2 13'")
  // Accept lines like: 10 Q2 12, or #7 Q1,5, or 9 Q3 8min, team label optional
  const goalLines = text.split(/\n/).filter(l=>/\bQ[1-4]\b/.test(l) && /\d/.test(l));
  goalLines.slice(0,12).forEach(line=>{
    // guess team by presence of Home/Away on same line; else leave picker default
    const num = (line.match(/#?(\d{1,3})/)||[])[1] || '';
    const q   = (line.match(/\b(Q[1-4])\b/i)||[])[1] || 'Q1';
    const min = (line.match(/\b(\d{1,2})\s*(?:min|')?\b/i)||[])[1] || '';
    addGoalRow({team:'home', num, q, min});
  });
}

/* ========= Roster & Goals editors ========= */
function playerRow(){ // quarters checkboxes + GK + Absent
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input class="num border rounded p-1 w-14 text-center" placeholder="#"></td>
    <td class="text-center"><input type="checkbox" class="abs"></td>
    <td class="text-center"><input type="checkbox" class="q q1"></td>
    <td class="text-center"><input type="checkbox" class="q q2"></td>
    <td class="text-center"><input type="checkbox" class="q q3"></td>
    <td class="text-center"><input type="checkbox" class="q q4"></td>
    <td class="text-center"><input type="checkbox" class="gk"></td>
    <td><button class="text-red-600 hover:underline del">Delete</button></td>`;
  tr.querySelector('.del').onclick=()=> tr.remove();
  return tr;
}
byId('addHomePlayer').onclick=()=> byId('homeRoster').querySelector('tbody')?.appendChild(playerRow());
byId('addAwayPlayer').onclick=()=> byId('awayRoster').querySelector('tbody')?.appendChild(playerRow());

function addGoalRow(pref={team:'home', num:'', q:'Q1', min:''}){
  const tb=byId('goalsTable').querySelector('tbody');
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><select class="team border rounded p-1"><option value="home">Home</option><option value="away">Away</option></select></td>
    <td><input class="num border rounded p-1 w-20" placeholder="#"></td>
    <td><select class="q border rounded p-1"><option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option></select></td>
    <td><input class="min border rounded p-1 w-20" type="number" min="0" placeholder="min"></td>
    <td><button class="text-red-600 hover:underline del">Delete</button></td>`;
  tr.querySelector('.del').onclick=()=>tr.remove();
  tb.appendChild(tr);
  tr.querySelector('.team').value=pref.team;
  tr.querySelector('.num').value=pref.num;
  tr.querySelector('.q').value=pref.q;
  tr.querySelector('.min').value=pref.min;
}
byId('addGoal').onclick=()=>addGoalRow();

/* ========= Collect & Reset ========= */
function collectRoster(tbody){
  return [...tbody.querySelectorAll('tr')].map(tr=>{
    return {
      num: tr.querySelector('.num')?.value.trim()||'',
      absent: tr.querySelector('.abs')?.checked||false,
      q:{
        Q1:tr.querySelector('.q1')?.checked||false,
        Q2:tr.querySelector('.q2')?.checked||false,
        Q3:tr.querySelector('.q3')?.checked||false,
        Q4:tr.querySelector('.q4')?.checked||false
      },
      gk: tr.querySelector('.gk')?.checked||false
    };
  });
}
function collectGoals(){
  return [...byId('goalsTable').querySelectorAll('tbody tr')].map(tr=>({
    team: tr.querySelector('.team').value,
    num: tr.querySelector('.num').value.trim(),
    q: tr.querySelector('.q').value,
    min: +tr.querySelector('.min').value || 0
  }));
}
function resetEditor(){
  ['m-id','m-date','m-div','m-field','m-home','m-away','m-hs','m-as','m-cr','m-ar1','m-ar2','m-notes'].forEach(id=>byId(id).value='');
  byId('homeRoster').querySelector('tbody').innerHTML='';
  byId('awayRoster').querySelector('tbody').innerHTML='';
  byId('goalsTable').querySelector('tbody').innerHTML='';
  ocr.front=ocr.back='';
  frontText.textContent=''; backText.textContent='';
  frontPrev.classList.add('hidden'); backPrev.classList.add('hidden');
  setRing(frontRing,0); setRing(backRing,0);
  frontStatus.textContent='Waiting…'; backStatus.textContent='Waiting…';
}
byId('clearMatch').onclick=resetEditor;

/* ========= Save Match ========= */
byId('saveMatch').onclick=()=>{
  const m = {
    id: byId('m-id').value || (prefs.autoId?`G-${uid()}`:''),
    date: byId('m-date').value,
    division: byId('m-div').value.trim(),
    field: byId('m-field').value.trim(),
    home: byId('m-home').value.trim(),
    away: byId('m-away').value.trim(),
    hs: +byId('m-hs').value||0,
    as: +byId('m-as').value||0,
    refs: {cr:byId('m-cr').value.trim(), ar1:byId('m-ar1').value.trim(), ar2:byId('m-ar2').value.trim()},
    roster: {
      home: collectRoster(byId('homeRoster').querySelector('tbody')),
      away: collectRoster(byId('awayRoster').querySelector('tbody')),
      qLen: prefs.qLen
    },
    goals: collectGoals(),
    notes: byId('m-notes').value.trim()
  };
  if(!m.date || !m.home || !m.away){ alert('Please fill Date, Home, and Away.'); return; }
  const idx=state.matches.findIndex(x=>x.id===m.id);
  if(idx>=0){ if(!confirm('Update existing match '+m.id+'?')) return; state.matches[idx]=m; }
  else state.matches.push(m);
  saveState();
  alert('Match saved.');
  renderMatches(); recompute(); renderRefs();
};

/* ========= Matches list ========= */
function renderMatches(){
  const tb = byId('matchesTable').querySelector('tbody'); tb.innerHTML='';
  const q = byId('matchSearch').value?.toLowerCase()||'';
  const fdiv = byId('filterDiv').value||'';
  const divisions=new Set();

  state.matches
    .filter(m=>(!q || [m.id,m.home,m.away].join(' ').toLowerCase().includes(q)) && (!fdiv || m.division===fdiv))
    .sort((a,b)=> (a.date||'').localeCompare(b.date||''))
    .forEach(m=>{
      divisions.add(m.division||'');
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${m.date||''}</td>
        <td>${m.id||''}</td>
        <td>${m.division||''}</td>
        <td>${m.field||''}</td>
        <td>${m.home}</td>
        <td class="text-center">vs</td>
        <td>${m.away}</td>
        <td>${m.refs.cr||''}</td>
        <td>${m.refs.ar1||''}</td>
        <td>${m.refs.ar2||''}</td>
        <td><span class="chip">${m.hs} - ${m.as}</span></td>
        <td>
          <button class="text-brand-600 hover:underline edit">Edit</button> ·
          <button class="text-red-600 hover:underline del">Delete</button>
        </td>`;
      tr.querySelector('.edit').onclick=()=>loadMatch(m.id);
      tr.querySelector('.del').onclick=()=>{ if(confirm('Delete match '+m.id+'?')){ state.matches=state.matches.filter(x=>x.id!==m.id); saveState(); renderMatches(); recompute(); renderRefs(); } };
      tb.appendChild(tr);
    });

  const sel=byId('filterDiv'); const prev=sel.value;
  sel.innerHTML='<option value="">All divisions</option>'+[...divisions].filter(Boolean).map(d=>`<option>${d}</option>`).join('');
  sel.value=prev||'';
}
byId('matchSearch').addEventListener('input', renderMatches);
byId('filterDiv').addEventListener('change', renderMatches);

function loadMatch(id){
  const m=state.matches.find(x=>x.id===id); if(!m) return;
  byId('m-id').value=m.id; byId('m-date').value=m.date; byId('m-div').value=m.division||''; byId('m-field').value=m.field||'';
  byId('m-home').value=m.home; byId('m-away').value=m.away; byId('m-hs').value=m.hs; byId('m-as').value=m.as;
  byId('m-cr').value=m.refs.cr||''; byId('m-ar1').value=m.refs.ar1||''; byId('m-ar2').value=m.refs.ar2||'';
  // rosters
  const H=byId('homeRoster').querySelector('tbody'); H.innerHTML='';
  m.roster?.home?.forEach(p=>{
    const tr=playerRow();
    tr.querySelector('.num').value=p.num||'';
    tr.querySelector('.abs').checked=!!p.absent;
    tr.querySelector('.q1').checked=!!p.q?.Q1;
    tr.querySelector('.q2').checked=!!p.q?.Q2;
    tr.querySelector('.q3').checked=!!p.q?.Q3;
    tr.querySelector('.q4').checked=!!p.q?.Q4;
    tr.querySelector('.gk').checked=!!p.gk;
    H.appendChild(tr);
  });
  const A=byId('awayRoster').querySelector('tbody'); A.innerHTML='';
  m.roster?.away?.forEach(p=>{
    const tr=playerRow();
    tr.querySelector('.num').value=p.num||'';
    tr.querySelector('.abs').checked=!!p.absent;
    tr.querySelector('.q1').checked=!!p.q?.Q1;
    tr.querySelector('.q2').checked=!!p.q?.Q2;
    tr.querySelector('.q3').checked=!!p.q?.Q3;
    tr.querySelector('.q4').checked=!!p.q?.Q4;
    tr.querySelector('.gk').checked=!!p.gk;
    A.appendChild(tr);
  });
  // goals
  const G=byId('goalsTable').querySelector('tbody'); G.innerHTML='';
  (m.goals||[]).forEach(g=> addGoalRow(g));

  byId('m-notes').value=m.notes||'';

  // jump to scan
  $$('nav .tab').find(t=>t.dataset.tab==='scan').click();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ========= Standings ========= */
function recompute(){
  const [WPTS,DPTS,LPTS]=prefs.pts || [3,1,0];
  byId('ptsRule').textContent=`W=${WPTS}, D=${DPTS}, L=${LPTS}`;
  const standings={}; // div -> team -> stats
  let goals=0, refs=0;
  const divisions=new Set();

  state.matches.forEach(m=>{
    const div=m.division||'—'; divisions.add(div);
    const T=(team)=> standings[div]?.[team] || {gp:0,w:0,d:0,l:0,gf:0,ga:0,pts:0};
    standings[div]=standings[div]||{};
    const h=T(m.home), a=T(m.away);
    h.gp++; a.gp++; h.gf+=m.hs; h.ga+=m.as; a.gf+=m.as; a.ga+=m.hs;
    if(m.hs>m.as){ h.w++; h.pts+=WPTS; a.l++; }
    else if(m.hs<m.as){ a.w++; a.pts+=WPTS; h.l++; }
    else { h.d++; a.d++; h.pts+=DPTS; a.pts+=DPTS; }
    standings[div][m.home]=h; standings[div][m.away]=a;

    goals += (m.hs||0)+(m.as||0);
    refs  += (m.refs.cr?1:0) + (m.refs.ar1?1:0) + (m.refs.ar2?1:0);
  });

  byId('kpiGames').textContent=state.matches.length;
  byId('kpiGoals').textContent=goals;
  byId('kpiRefs').textContent=refs;
  byId('kpiDivs').textContent=[...divisions].filter(Boolean).length;

  const tb=byId('standingsTable').querySelector('tbody'); tb.innerHTML='';
  Object.entries(standings).forEach(([div,teams])=>{
    Object.entries(teams)
      .map(([team,s])=>({...s,team,div,gd:s.gf-s.ga}))
      .sort((a,b)=> a.div.localeCompare(b.div) || b.pts-a.pts || b.gd-a.gd || b.gf-a.gf)
      .forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.div}</td><td>${r.team}</td><td>${r.gp}</td><td>${r.w}</td><td>${r.d}</td><td>${r.l}</td><td>${r.gf}</td><td>${r.ga}</td><td>${r.gd}</td><td>${r.pts}</td>`;
        tb.appendChild(tr);
      });
  });
}

/* ========= Refs ========= */
function renderRefs(){
  const tally={};
  state.matches.forEach(m=>{
    if(m.refs.cr){ (tally[m.refs.cr]=tally[m.refs.cr]||{cr:0,ar1:0,ar2:0}).cr++; }
    if(m.refs.ar1){ (tally[m.refs.ar1]=tally[m.refs.ar1]||{cr:0,ar1:0,ar2:0}).ar1++; }
    if(m.refs.ar2){ (tally[m.refs.ar2]=tally[m.refs.ar2]||{cr:0,ar1:0,ar2:0}).ar2++; }
  });
  const tb=byId('refsTable').querySelector('tbody'); tb.innerHTML='';
  Object.entries(tally).sort((a,b)=> (b[1].cr+b[1].ar1+b[1].ar2) - (a[1].cr+a[1].ar1+a[1].ar2))
    .forEach(([name,t])=>{
      const tot=(t.cr||0)+(t.ar1||0)+(t.ar2||0);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${name}</td><td>${t.cr||0}</td><td>${t.ar1||0}</td><td>${t.ar2||0}</td><td>${tot}</td>`;
      tb.appendChild(tr);
    });
}

/* ========= Export ========= */
byId('exMatches').onclick=()=>{
  const rows=[['gameId','date','division','field','homeTeam','homeScore','awayScore','awayTeam','CR','AR1','AR2','notes']];
  state.matches.forEach(m=>{
    rows.push([m.id,m.date,m.division,m.field,m.home,m.hs,m.as,m.away,m.refs.cr||'',m.refs.ar1||'',m.refs.ar2||'',m.notes||'']);
  });
  saveAs(new Blob([toCSV(rows)],{type:'text/csv;charset=utf-8'}),'matches.csv');
};

byId('exStandings').onclick=()=>{
  // recompute then flatten
  const [WPTS,DPTS]=prefs.pts || [3,1,0];
  const table={};
  state.matches.forEach(m=>{
    const d=m.division||'—';
    table[d]=table[d]||{};
    const T=(t)=> table[d][t] || {gp:0,w:0,d:0,l:0,gf:0,ga:0};
    const h=T(m.home), a=T(m.away);
    h.gp++; a.gp++; h.gf+=m.hs; h.ga+=m.as; a.gf+=m.as; a.ga+=m.hs;
    if(m.hs>m.as){ h.w++; a.l++; } else if(m.hs<m.as){ a.w++; h.l++; } else { h.d++; a.d++; }
    table[d][m.home]=h; table[d][m.away]=a;
  });
  const rows=[['division','team','gp','w','d','l','gf','ga','gd','pts']];
  Object.entries(table).forEach(([div,teams])=>{
    Object.entries(teams).forEach(([name,s])=>{
      rows.push([div,name,s.gp,s.w,s.d,s.l,s.gf,s.ga,s.gf-s.ga, s.w*(WPTS)+(s.d*(DPTS))]);
    });
  });
  saveAs(new Blob([toCSV(rows)],{type:'text/csv;charset=utf-8'}),'standings.csv');
};

byId('exRefs').onclick=()=>{
  const tally={};
  state.matches.forEach(m=>{
    if(m.refs.cr){ (tally[m.refs.cr]=tally[m.refs.cr]||{cr:0,ar1:0,ar2:0}).cr++; }
    if(m.refs.ar1){ (tally[m.refs.ar1]=tally[m.refs.ar1]||{cr:0,ar1:0,ar2:0}).ar1++; }
    if(m.refs.ar2){ (tally[m.refs.ar2]=tally[m.refs.ar2]||{cr:0,ar1:0,ar2:0}).ar2++; }
  });
  const rows=[['name','CR','AR1','AR2','total']];
  Object.entries(tally).forEach(([n,t])=> rows.push([n,t.cr||0,t.ar1||0,t.ar2||0,(t.cr||0)+(t.ar1||0)+(t.ar2||0)]));
  saveAs(new Blob([toCSV(rows)],{type:'text/csv;charset=utf-8'}),'refs.csv');
};

byId('exJSON').onclick=()=>{
  saveAs(new Blob([JSON.stringify(state,null,2)],{type:'application/json'}),'coachdesk-backup.json');
};

/* ========= Import Schedule ========= */
byId('impCSV').addEventListener('change', async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const txt=await f.text();
  const lines=txt.split(/\r?\n/).filter(Boolean);
  const header=(lines.shift()||'').split(',').map(h=>h.trim());
  const idx=k=>header.indexOf(k);

  let created=0, skipped=0;
  lines.forEach(line=>{
    const cols = line.match(/("([^"]*)"|[^,]+)/g)?.map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"'))||[];
    if(!cols.length){ skipped++; return; }
    const id = cols[idx('gameId')]||`G-${uid()}`;
    if(state.matches.find(x=>x.id===id)){ skipped++; return; }
    const m = {
      id, date: cols[idx('date')]||'', division: cols[idx('division')]||'',
      field: cols[idx('field')]||'', home: cols[idx('homeTeam')]||'', away: cols[idx('awayTeam')]||'',
      hs:0, as:0, refs:{cr:'',ar1:'',ar2:''}, roster:{home:[],away:[],qLen:prefs.qLen}, goals:[], notes:''
    };
    state.matches.push(m); created++;
  });
  saveState();
  alert(`Imported ${created} matches. ${skipped} skipped (duplicates/empty).`);
  renderMatches();
});

/* ========= Settings ========= */
function applyPrefs(){
  document.documentElement.classList.toggle('dark', !!prefs.dark);
  byId('optDark').checked = !!prefs.dark;
  byId('optAutoId').checked = !!prefs.autoId;
  byId('optLocal').checked = true;
  byId('ptsW').value = (prefs.pts||[3,1,0])[0];
  byId('ptsD').value = (prefs.pts||[3,1,0])[1];
  byId('ptsL').value = (prefs.pts||[3,1,0])[2];
  byId('qLen').value = prefs.qLen||15;
}
byId('savePrefs').onclick=()=>{
  prefs.dark = byId('optDark').checked;
  prefs.autoId = byId('optAutoId').checked;
  prefs.pts = [ +byId('ptsW').value||3, +byId('ptsD').value||1, +byId('ptsL').value||0 ];
  prefs.qLen = +byId('qLen').value || 15;
  savePrefs();
  alert('Settings saved.');
  recompute();
};
byId('wipeAll').onclick=()=>{
  if(confirm('Wipe ALL local data?')){ state={matches:[]}; saveState(); renderMatches(); recompute(); renderRefs(); }
};

/* ========= Init ========= */
byId('year').textContent = new Date().getFullYear();
applyPrefs(); renderMatches(); recompute(); renderRefs();
  </script>
</body>
</html>
