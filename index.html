<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AYSO Game Card Scanner • Coach Desk</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{extend:{
        colors:{brand:{
          50:'#e6f6f5',100:'#cef0ee',200:'#9ddfdb',300:'#6bcfcc',
          400:'#39c0ba',500:'#12b3ac',600:'#0f766e',
          700:'#0d5e58',800:'#0b4742',900:'#08312e'}},
        boxShadow:{soft:'0 10px 28px rgba(0,0,0,.12)'},
        fontFamily:{sans:['Inter','ui-sans-serif','system-ui','sans-serif']}
      }}
    }
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400..800&display=swap" rel="stylesheet" />

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <!-- FileSaver for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    html,body{height:100%}
    .btn{ @apply inline-flex items-center justify-center rounded-lg px-4 py-2 font-medium shadow-soft transition;
          background: linear-gradient(180deg,#12b3ac 0%,#0f766e 100%); color:white }
    .btn:hover{filter:brightness(1.05)}
    .btn-ghost{@apply rounded-lg px-4 py-2 border border-slate-300 text-slate-800 hover:bg-slate-50}
    .card{@apply rounded-2xl border border-slate-200 bg-white p-5 shadow-soft}
    .tab{ @apply px-4 py-2 rounded-full text-sm font-medium cursor-pointer }
    .tab-active{@apply bg-slate-900 text-white}
    .tab-inactive{@apply bg-slate-100 text-slate-700 hover:bg-slate-200}
    .kpi{ @apply text-center rounded-xl bg-slate-50 p-4 border border-slate-200 }
    .table{ @apply w-full text-sm border border-slate-200 rounded-xl overflow-hidden }
    .table th{ @apply bg-slate-100 text-left px-3 py-2 }
    .table td{ @apply border-t border-slate-200 px-3 py-2 }
  </style>
</head>
<body class="bg-white text-slate-900 font-sans">

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="h-8 w-8 rounded-full bg-brand-600 inline-block"></span>
        <span class="font-semibold">Coach Desk — Game Card Scanner</span>
      </div>
      <nav class="hidden md:flex gap-2">
        <button class="tab tab-active" data-tab="scan">Scan</button>
        <button class="tab tab-inactive" data-tab="matches">Matches</button>
        <button class="tab tab-inactive" data-tab="standings">Standings</button>
        <button class="tab tab-inactive" data-tab="refs">Refs</button>
        <button class="tab tab-inactive" data-tab="export">Import/Export</button>
        <button class="tab tab-inactive" data-tab="settings">Settings</button>
      </nav>
    </div>
  </header>

  <!-- Main wrapper -->
  <main class="mx-auto max-w-7xl px-4 py-8 space-y-8">
    <!-- Scan -->
    <section id="tab-scan" class="grid gap-6">
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Front of card -->
        <div class="card">
          <h2 class="text-lg font-semibold">Front of Game Card</h2>
          <input id="frontInput" type="file" accept="image/*" capture="environment" class="mt-2 block w-full border p-2 rounded-lg"/>
          <div id="frontDrop" class="mt-3 rounded-xl border-2 border-dashed border-slate-300 p-6 text-center text-slate-500">
            Drop front image here
          </div>
          <div class="mt-2 text-sm text-slate-600">OCR Progress</div>
          <progress id="frontProgress" class="w-full" value="0" max="100"></progress>
          <button id="frontShow" class="btn-ghost mt-2 hidden">Show detected text</button>
          <pre id="frontText" class="hidden text-xs bg-slate-50 p-2 rounded"></pre>
        </div>

        <!-- Back of card -->
        <div class="card">
          <h2 class="text-lg font-semibold">Back of Game Card</h2>
          <input id="backInput" type="file" accept="image/*" capture="environment" class="mt-2 block w-full border p-2 rounded-lg"/>
          <div id="backDrop" class="mt-3 rounded-xl border-2 border-dashed border-slate-300 p-6 text-center text-slate-500">
            Drop back image here
          </div>
          <div class="mt-2 text-sm text-slate-600">OCR Progress</div>
          <progress id="backProgress" class="w-full" value="0" max="100"></progress>
          <button id="backShow" class="btn-ghost mt-2 hidden">Show detected text</button>
          <pre id="backText" class="hidden text-xs bg-slate-50 p-2 rounded"></pre>
        </div>
      </div>

      <!-- Match form -->
      <div class="card">
        <h2 class="text-lg font-semibold">Match Review & Entry</h2>
        <p class="text-sm text-slate-600">Fields below autofill from OCR. Review and adjust before saving.</p>

        <form id="matchForm" class="grid grid-cols-2 gap-3 mt-4">
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Game ID</span>
            <input name="gameId" class="w-full border rounded-lg p-2" placeholder="e.g., 12-3-104" required />
          </label>
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Date</span>
            <input name="date" type="date" class="w-full border rounded-lg p-2" required />
          </label>
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Division</span>
            <input name="division" class="w-full border rounded-lg p-2" placeholder="12U Boys" />
          </label>
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Field</span>
            <input name="field" class="w-full border rounded-lg p-2" placeholder="Field 3" />
          </label>
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Home Team</span>
            <input name="homeTeam" class="w-full border rounded-lg p-2" required />
          </label>
          <label class="col-span-1">
            <span class="text-xs text-slate-600">Away Team</span>
            <input name="awayTeam" class="w-full border rounded-lg p-2" required />
          </label>
        </form>

        <!-- Scores + Refs -->
        <div class="grid grid-cols-2 gap-3 mt-4">
          <label>
            <span class="text-xs text-slate-600">Home Score</span>
            <input name="homeScore" type="number" min="0" class="w-full border rounded-lg p-2" value="0"/>
          </label>
          <label>
            <span class="text-xs text-slate-600">Away Score</span>
            <input name="awayScore" type="number" min="0" class="w-full border rounded-lg p-2" value="0"/>
          </label>
        </div>

        <div class="grid grid-cols-3 gap-3 mt-4">
          <input name="cr" placeholder="Center Ref" class="border rounded-lg p-2"/>
          <input name="ar1" placeholder="Assistant Ref 1" class="border rounded-lg p-2"/>
          <input name="ar2" placeholder="Assistant Ref 2" class="border rounded-lg p-2"/>
        </div>

        <!-- Rosters -->
        <div class="grid md:grid-cols-2 gap-6 mt-6">
          <div>
            <h3 class="font-semibold">Home Roster & Quarters</h3>
            <p class="text-xs text-slate-600">Track per quarter (✓ played / empty = sat)</p>
            <table class="table mt-2">
              <thead>
                <tr><th>#</th><th>Absent</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>GK</th></tr>
              </thead>
              <tbody id="homeRoster"></tbody>
            </table>
            <button id="addHomePlayer" class="btn-ghost mt-2">Add Player</button>
          </div>

          <div>
            <h3 class="font-semibold">Away Roster & Quarters</h3>
            <p class="text-xs text-slate-600">Track per quarter (✓ played / empty = sat)</p>
            <table class="table mt-2">
              <thead>
                <tr><th>#</th><th>Absent</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>GK</th></tr>
              </thead>
              <tbody id="awayRoster"></tbody>
            </table>
            <button id="addAwayPlayer" class="btn-ghost mt-2">Add Player</button>
          </div>
        </div>

        <!-- Goals & Events -->
        <div class="mt-6">
          <h3 class="font-semibold">Goals & Events</h3>
          <table class="table mt-2">
            <thead>
              <tr><th>Team</th><th>Player #</th><th>Quarter</th><th>Minute</th></tr>
            </thead>
            <tbody id="goalsTable"></tbody>
          </table>
          <button id="addGoal" class="btn-ghost mt-2">Add Goal</button>
          <textarea name="notes" rows="2" placeholder="Cards, injuries, highlights" class="mt-3 w-full border rounded-lg p-2"></textarea>
        </div>

        <div class="mt-6 flex gap-3">
          <button id="btnSave" class="btn">Save Match</button>
          <button id="btnClear" class="btn-ghost">Start New</button>
        </div>
      </div>
    </section>
    <!-- Matches -->
    <section id="tab-matches" class="hidden">
      <div class="card">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Saved Matches</h2>
          <div class="flex gap-2">
            <input id="searchMatch" placeholder="Search team or gameId…" class="border rounded-lg p-2"/>
            <button id="btnRecalc" class="btn-ghost">Recalculate Standings</button>
          </div>
        </div>
        <div class="mt-4 overflow-x-auto">
          <table class="table" id="matchesTable">
            <thead>
              <tr>
                <th>Date</th><th>Game</th><th>Division</th><th>Field</th>
                <th>Home</th><th>Score</th><th>Away</th>
                <th>CR</th><th>AR1</th><th>AR2</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Standings -->
    <section id="tab-standings" class="hidden">
      <div class="grid md:grid-cols-4 gap-6">
        <div class="kpi"><div class="text-2xl font-semibold" id="kpiGames">0</div><div class="text-slate-600 text-sm">Games</div></div>
        <div class="kpi"><div class="text-2xl font-semibold" id="kpiGoals">0</div><div class="text-slate-600 text-sm">Goals</div></div>
        <div class="kpi"><div class="text-2xl font-semibold" id="kpiRefs">0</div><div class="text-slate-600 text-sm">Ref Assignments</div></div>
        <div class="kpi"><div class="text-2xl font-semibold" id="kpiDivs">0</div><div class="text-slate-600 text-sm">Divisions</div></div>
      </div>
      <div class="card mt-6">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Standings</h2>
          <div class="text-sm text-slate-600">W=3, D=1, L=0</div>
        </div>
        <div class="mt-4 overflow-x-auto">
          <table class="table" id="standingsTable">
            <thead>
              <tr>
                <th>Division</th><th>Team</th><th>GP</th><th>W</th><th>D</th><th>L</th>
                <th>GF</th><th>GA</th><th>GD</th><th>Pts</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Refs -->
    <section id="tab-refs" class="hidden">
      <div class="card">
        <h2 class="text-lg font-semibold">Referee Assignments</h2>
        <div class="mt-4 overflow-x-auto">
          <table class="table" id="refsTable">
            <thead>
              <tr><th>Name</th><th>CR</th><th>AR1</th><th>AR2</th><th>Total</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Import/Export -->
    <section id="tab-export" class="hidden grid lg:grid-cols-2 gap-6">
      <div class="card">
        <h2 class="text-lg font-semibold">Export</h2>
        <p class="text-sm text-slate-600">Save your data</p>
        <div class="mt-4 flex flex-wrap gap-2">
          <button class="btn" id="exportMatches">Matches CSV</button>
          <button class="btn" id="exportStandings">Standings CSV</button>
          <button class="btn" id="exportRefs">Refs CSV</button>
          <button class="btn-ghost" id="exportJSON">Backup JSON</button>
        </div>
      </div>
      <div class="card">
        <h2 class="text-lg font-semibold">Import Schedule (CSV)</h2>
        <p class="text-sm text-slate-600">Format: gameId,date,division,field,homeTeam,awayTeam</p>
        <input id="importCSV" type="file" accept=".csv" class="mt-4 border rounded-lg p-2"/>
      </div>
    </section>

    <!-- Settings -->
    <section id="tab-settings" class="hidden">
      <div class="card">
        <h2 class="text-lg font-semibold">Settings</h2>
        <div class="mt-4 grid sm:grid-cols-2 gap-4">
          <label class="flex items-center gap-3">
            <input id="optAutoId" type="checkbox" class="h-4 w-4 border rounded"/>
            <span class="text-sm">Auto-generate Game IDs if missing</span>
          </label>
          <label class="flex items-center gap-3">
            <input id="optLocalOnly" type="checkbox" class="h-4 w-4 border rounded" checked/>
            <span class="text-sm">Store data locally (browser only)</span>
          </label>
          <label class="flex items-center gap-3">
            <input id="optDark" type="checkbox" class="h-4 w-4 border rounded"/>
            <span class="text-sm">Dark mode</span>
          </label>
        </div>
        <div class="mt-6 flex gap-2">
          <button id="wipe" class="btn-ghost">Wipe All Local Data</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="border-t border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-8 text-sm text-slate-600 flex items-center justify-between">
      <span>© <span id="year"></span> Coach Desk</span>
      <span class="chip">Offline-ready</span>
    </div>
  </footer>

  <!-- JavaScript -->
  <script>
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
  const LS_KEY='coachdesk:data';
  const state=JSON.parse(localStorage.getItem(LS_KEY)||'{"matches":[]}');
  const saveState=()=>localStorage.setItem(LS_KEY,JSON.stringify(state));

  // Tabs
  const tabs=$$('.tab'); 
  const sections={scan:$('#tab-scan'),matches:$('#tab-matches'),standings:$('#tab-standings'),refs:$('#tab-refs'),export:$('#tab-export'),settings:$('#tab-settings')};
  tabs.forEach(btn=>{
    btn.addEventListener('click',()=>{
      tabs.forEach(b=>b.classList.replace('tab-active','tab-inactive'));
      btn.classList.replace('tab-inactive','tab-active');
      Object.entries(sections).forEach(([k,el])=>el.classList.toggle('hidden',k!==btn.dataset.tab));
      if(btn.dataset.tab==='matches') renderMatches();
      if(btn.dataset.tab==='standings') recomputeStandings();
      if(btn.dataset.tab==='refs') renderRefs();
    });
  });

  // Dummy add player rows
  function addPlayerRow(tbody,team){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input size=2/></td>
      <td><input type="checkbox"/></td>
      <td><input type="checkbox"/></td>
      <td><input type="checkbox"/></td>
      <td><input type="checkbox"/></td>
      <td><input type="checkbox"/></td>
      <td><input type="checkbox"/></td>`;
    tbody.appendChild(tr);
  }
  $('#addHomePlayer').onclick=()=>addPlayerRow($('#homeRoster'));
  $('#addAwayPlayer').onclick=()=>addPlayerRow($('#awayRoster'));

  // Save match
  $('#btnSave').onclick=()=>{
    const F=$('#matchForm');
    const m={
      gameId:F.gameId.value||`G-${Date.now()}`,
      date:F.date.value,
      division:F.division.value,
      field:F.field.value,
      home:F.homeTeam.value,
      away:F.awayTeam.value,
      homeScore:F.homeScore?.value||0,
      awayScore:F.awayScore?.value||0,
      cr:F.cr?.value,ar1:F.ar1?.value,ar2:F.ar2?.value
    };
    state.matches.push(m); saveState(); alert('Match saved');
  };

  function renderMatches(){
    const tbody=$('#matchesTable tbody'); tbody.innerHTML='';
    state.matches.forEach(m=>{
      tbody.innerHTML+=`<tr><td>${m.date}</td><td>${m.gameId}</td>
        <td>${m.division}</td><td>${m.field}</td>
        <td>${m.home}</td><td>${m.homeScore}-${m.awayScore}</td><td>${m.away}</td>
        <td>${m.cr||''}</td><td>${m.ar1||''}</td><td>${m.ar2||''}</td></tr>`;
    });
  }

  function recomputeStandings(){
    const table={};
    state.matches.forEach(m=>{
      const div=m.division||'Unknown';
      if(!table[div]) table[div]={};
      [ [m.home,m.homeScore,m.awayScore], [m.away,m.awayScore,m.homeScore] ].forEach(([team,gf,ga])=>{
        if(!table[div][team]) table[div][team]={gp:0,w:0,d:0,l:0,gf:0,ga:0};
        const t=table[div][team]; t.gp++; t.gf+=+gf; t.ga+=+ga;
        if(gf>ga) t.w++; else if(gf==ga) t.d++; else t.l++;
      });
    });
    const tbody=$('#standingsTable tbody'); tbody.innerHTML='';
    Object.entries(table).forEach(([div,teams])=>{
      Object.entries(teams).forEach(([team,t])=>{
        const pts=t.w*3+t.d;
        const gd=t.gf-t.ga;
        tbody.innerHTML+=`<tr><td>${div}</td><td>${team}</td>
          <td>${t.gp}</td><td>${t.w}</td><td>${t.d}</td><td>${t.l}</td>
          <td>${t.gf}</td><td>${t.ga}</td><td>${gd}</td><td>${pts}</td></tr>`;
      });
    });
  }

  function renderRefs(){
    const refs={};
    state.matches.forEach(m=>{
      [ ['cr',m.cr], ['ar1',m.ar1], ['ar2',m.ar2] ].forEach(([role,name])=>{
        if(!name) return;
        if(!refs[name]) refs[name]={cr:0,ar1:0,ar2:0};
        refs[name][role]++;
      });
    });
    const tbody=$('#refsTable tbody'); tbody.innerHTML='';
    Object.entries(refs).forEach(([name,r])=>{
      const tot=r.cr+r.ar1+r.ar2;
      tbody.innerHTML+=`<tr><td>${name}</td><td>${r.cr}</td><td>${r.ar1}</td><td>${r.ar2}</td><td>${tot}</td></tr>`;
    });
  }

  // Export
  function toCSV(rows){return rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');}
  $('#exportMatches').onclick=()=>{
    const rows=[['Date','Game','Division','Field','Home','HomeScore','AwayScore','Away','CR','AR1','AR2']];
    state.matches.forEach(m=>rows.push([m.date,m.gameId,m.division,m.field,m.home,m.homeScore,m.awayScore,m.away,m.cr,m.ar1,m.ar2]));
    saveAs(new Blob([toCSV(rows)],{type:'text/csv'}),'matches.csv');
  };
  $('#exportStandings').onclick=()=>{alert('Standings export not yet wired')};
  $('#exportRefs').onclick=()=>{alert('Refs export not yet wired')};
  $('#exportJSON').onclick=()=>saveAs(new Blob([JSON.stringify(state)],{type:'application/json'}),'backup.json');

  // Reset
  $('#wipe').onclick=()=>{ if(confirm('Clear all data?')){localStorage.removeItem(LS_KEY); location.reload();} };

  $('#year').textContent=new Date().getFullYear();
  </script>
</body>
</html>
